name: "[misc] Post Merge - Process Jurisdiction Entry"
on:
  push:
    branches: [main]
    paths:
      - "data_source/**/jurisdictions.yml" # domain change
  
jobs:
  process-updated-jurisdiction-entry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 1

      - name: Setup mise
        uses: jdx/mise-action@v3.2.0
        with:
          version: "2025.9.6"
          cache: true
          log_level: debug
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get updated jurisdictions entry
        run: |
          poetry run python scripts/github_actions/local/post_merge/process_updated_jurisdiction_entry.py

      - name: Call od_sync
        run: |
          JURISDICTION_OCDIDS_ARRAY=$(cat updated_jurisdiction_ocdids.txt | jq -R -s -c 'split("\n")[:-1]')
          echo "Updated jurisdiction OCDIDs: $JURISDICTION_OCDIDS_ARRAY"
          curl -X POST "$API_CIVICPATCH_ORG_URL/api/admin/od_sync" \
            -H "Content-Type: application/json" \
            -H "Authorization: $API_CIVICPATCH_ORG_TOKEN" \
            --fail-with-body \
            -d "{\"jurisdiction_ocdids\": $JURISDICTION_OCDIDS_ARRAY}"