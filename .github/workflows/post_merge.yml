name: "[auto] Post Merge"
on:
  push:
    branches: [main]
    paths:
      - "data/**/*.yml" # newly scraped jurisdiction
      - "data_source/**/jurisdictions.yml" # manual update to jurisdictions

concurrency:
  group: post-merge-main
  cancel-in-progress: false

  #workflow_dispatch:
  #  inputs:
  #    state:
  #      description: 'state intitials'
  #      required: true
  #      type: choice
  #      options:
  #        - co
  #        - wa

permissions:
  contents: write

jobs:
  extract-files:
    runs-on: ubuntu-latest
    outputs:
      jurisdiction-ocdids: ${{ steps.extract-from-files.outputs.jurisdiction-ocdids }}
      states: ${{ steps.extract-states.outputs.states }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0 # Fetch all history for accurate diffing

      - name: Setup mise
        uses: jdx/mise-action@v3.2.0
        with:
          version: "2025.9.6"
          cache: true
          log_level: debug
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install poetry dependencies
        run: |
          poetry install

      - name: Extract updated states
        id: extract-states
        run: |
          # Get the list of updated files
          UPDATED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
          # Extract unique state directories from the updated files
          STATES=$(echo "$UPDATED_FILES" | grep -E '^(data|data_source)/' | cut -d/ -f2 | sort -u)
          STATES_CSV=$(echo "$STATES" | paste -sd "," -)
          echo "states=$STATES_CSV" >> $GITHUB_OUTPUT

      - name: Extract updated jurisdiction ocdids
        id: extract-from-files
        run: |
          # Get the list of updated YAML files under data/**/**.yml
          UPDATED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
          echo "Updated files:"
          echo "$UPDATED_FILES"

          LOCAL_DATA_FILES=$(echo "$UPDATED_FILES" | grep -E '^data/.*\.yml$' || true)
          echo "Local data files:"
          echo "$LOCAL_DATA_FILES"
          # Join the file paths with commas
          LOCAL_DATA_FILES_CSV=$(echo "$LOCAL_DATA_FILES" | paste -sd "," -)
          echo $LOCAL_DATA_FILES_CSV
          # Extract jurisdiction ocdids from the updated files
          JURISDICTION_OCDIDS=$(poetry run python scripts/github_actions/extract_jurisdiction_ocdids.py $LOCAL_DATA_FILES_CSV)
          echo "jurisdiction ocdids: $JURISDICTION_OCDIDS"
          # Convert to JSON array for matrix
          JURISDICTION_OCDIDS_JSON=$(echo $JURISDICTION_OCDIDS | jq -R -c 'split(",")')
          echo "jurisdiction JSON array: $JURISDICTION_OCDIDS_JSON"
          echo "jurisdiction-ocdids=$JURISDICTION_OCDIDS_JSON" >> $GITHUB_OUTPUT

  upload-images:
    environment: env-${{ github.actor }}
    needs: [extract-files]
    if: ${{ needs.extract-files.outputs.jurisdiction-ocdids != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        jurisdiction_ocdid: ${{ fromJson(needs.extract-files.outputs.jurisdiction-ocdids) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@v3.2.0
        with:
          version: "2025.9.6"
          cache: true
          log_level: debug
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install poetry dependencies
        run: |
          poetry install

      - name: Upload images to CDN
        env:
          FRIENDLY_STORAGE_HOST: ${{ vars.FRIENDLY_STORAGE_HOST }}
          STORAGE_ENDPOINT: ${{ secrets.STORAGE_ENDPOINT }}
          STORAGE_ACCESS_KEY_ID: ${{ secrets.STORAGE_ACCESS_KEY_ID }}
          STORAGE_SECRET_ACCESS_KEY: ${{ secrets.STORAGE_SECRET_ACCESS_KEY }}
        run: |
          mise upload-images-to-cdn --jurisdiction-ocdid "${{ matrix.jurisdiction_ocdid }}"
          # Remove local images after upload TODO
        
      - name: Get jurisdiction_folder
        id: get-jurisdiction-folder
        run: |
          JURISDICTION_FOLDER=$(poetry run python scripts/github_actions/get_jurisdiction_folder.py "${{ matrix.jurisdiction_ocdid }}")
          echo "jurisdiction-folder=$JURISDICTION_FOLDER" >> "$GITHUB_OUTPUT"
          # Hash the ocdid for artifact name
          HASHED_OCDID=$(echo -n "${{ matrix.jurisdiction_ocdid }}" | sha256sum | cut -d' ' -f1)
          echo "hashed-ocdid=$HASHED_OCDID" >> "$GITHUB_OUTPUT"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: images-${{ steps.get-jurisdiction-folder.outputs.hashed-ocdid }}
          path: | # https://github.com/actions/upload-artifact/issues/174#issuecomment-2878874192
            dummy-preserve-hierarchy.txt 
            data/${{ steps.get-jurisdiction-folder.outputs.jurisdiction-folder }}*

  commit-image-updates:
    runs-on: ubuntu-latest
    needs: [extract-files, upload-images]
    if: ${{ needs.extract-files.outputs.jurisdiction-ocdids != '[]' }}
    steps:
      - name: Generate GitHub App Pipeline Token
        id: generate-pipeline-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP_BOT_PIPELINE_APP_ID }}
          private-key: ${{ secrets.GH_APP_BOT_PIPELINE_PRIVATE_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.generate-pipeline-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.generate-pipeline-token.outputs.token }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: main
          # Use default token for auth (prevents workflow loops)
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: images-*
          path: downloaded-artifacts
          merge-multiple: true

      - name: Move files to correct location
        run: |
          # Artifacts are downloaded with their upload path preserved when merge-multiple is used
          # Move everything from the download directory to the repo root
          if [ -d "downloaded-artifacts" ]; then
            cp -r downloaded-artifacts/* .
            rm -rf downloaded-artifacts
          fi

      - name: Commit image updates
        run: |
          # Configure git with custom bot identity
          git config --global user.name '${{ steps.generate-pipeline-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate-pipeline-token.outputs.app-slug }}[bot]@users.noreply.github.com'

          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            git add data/
            git status
            
            # Pull any changes that happened since checkout
            git pull --rebase origin main
            
            git commit -m "Upload images to CDN [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

  post-merge:
    environment: env-${{ github.actor }}
    needs: [extract-files, commit-image-updates]
    if: |
      always() &&
      needs.extract-files.outputs.states != '' &&
      (needs.commit-image-updates.result == 'success' || needs.commit-image-updates.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Pipeline Token
        id: generate-pipeline-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP_BOT_PIPELINE_APP_ID }}
          private-key: ${{ secrets.GH_APP_BOT_PIPELINE_PRIVATE_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.generate-pipeline-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.generate-pipeline-token.outputs.token }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: main
          # Use default token for auth (prevents workflow loops)
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@v3.2.0
        with:
          version: "2025.9.6"
          cache: true
          log_level: debug
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install poetry dependencies
        run: |
          mise ls
          poetry install

      - name: Update progress files for each state
        run: |
          for state in $(echo "${{ needs.extract-files.outputs.states }}" | tr ',' ' '); do
            echo "Processing state: $state"
            poetry run python scripts/github_actions/update_jurisdiction_metadata.py "$state"
          done
          poetry run python scripts/track_progress/main.py
          poetry run python scripts/track_progress/generate_readme.py

      - name: Commit changes to main
        run: |
          # Configure git with custom bot identity
          git config --global user.name '${{ steps.generate-pipeline-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate-pipeline-token.outputs.app-slug }}[bot]@users.noreply.github.com'

          # Commit only specific files
          if [ -n "$(git status --porcelain)" ]; then
            # Pull latest changes before committing
            git pull --rebase origin main
            
            git add README.md progress.json
            git commit -m "Update jurisdiction_metadata.yml [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi 

      - name: Call od_sync
        env:
          API_CIVICPATCH_ORG_TOKEN: ${{ secrets.API_CIVICPATCH_ORG_TOKEN }}
          API_CIVICPATCH_ORG_URL: ${{ vars.API_CIVICPATCH_ORG_URL }}
        run: |
          curl -X POST "$API_CIVICPATCH_ORG_URL/api/admin/od_sync" \
            -H "Content-Type: application/json" \
            -H "Authorization: $API_CIVICPATCH_ORG_TOKEN" \
            --fail-with-body