name: "[misc] Pull Request Updated"
on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "data/**/*.yml" # newly scraped jurisdiction
    
permissions:
  contents: write

jobs:
  should-run:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_changes.outputs.should_run }}
      changed_file: ${{ steps.check_changes.outputs.changed_file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 100

      - name: Find changed data/**/*.yml files
        id: check_changes
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E '^data/.+\.yml$' || true)
          echo "Changed files: $CHANGED_FILES"
          NUM_CHANGED=$(echo "$CHANGED_FILES" | grep -c . || true)
          echo "Number of changed files: $NUM_CHANGED"
          if [ "$NUM_CHANGED" -eq 1 ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "changed_file=$(echo "$CHANGED_FILES" | head -n 1)" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "changed_file=" >> $GITHUB_OUTPUT
          fi

#  create-update-config:
#    runs-on: ubuntu-latest
#    needs: should-run
#    if: needs.should-run.outputs.should_run == 'true'
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v5
#        with:
#          ref: ${{ github.head_ref }}
#          fetch-depth: 1
#
#      - name: Setup mise
#        uses: jdx/mise-action@v3.2.0
#        with:
#          version: "2025.9.6"
#          cache: true
#          log_level: debug
#          github_token: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Install poetry dependencies
#        run: poetry install
#
#      - name: Create or update config.yml for new or updated jurisdiction
#        run: |
#          updated_data_file_path="${{ needs.should-run.outputs.changed_file }}"
#          echo "Updated data file path: $updated_data_file_path"
#          poetry run python scripts/github_actions/local/pull_request/create_update_config.py "$updated_data_file_path"
#
#      - name: Commit config.yml updates
#        run: |
#          git config --global user.name 'github-actions[bot]'
#          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
#          if [ -n "$(git status --porcelain)" ]; then
#            git add .
#            git commit -m "Update config.yml for new/updated jurisdiction"
#            git push origin HEAD:${{ github.head_ref }}
#          else
#            echo "No changes to commit"
#          fi