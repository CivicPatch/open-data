name: "[misc] Pull Request Updated"
on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "data/**/*.yml" # newly scraped jurisdiction
    
permissions:
  contents: write

jobs:
  should-run:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_changes.outputs.should_run }}
    steps:
      # If more than 1 data/**/*.yml files are changed, should_run is false
      - name: Check if only one data/**/*.yml file is changed
        id: check_changes
        run: |
          changed_files=$(echo "${{ github.event.pull_request.changed_files }}" | grep -E "data/.+\.yml" || true)
          num_changed_files=$(echo "$changed_files" | wc -l)
          echo "Changed files: $changed_files"
          echo "Number of changed files: $num_changed_files"
          if [ "$num_changed_files" -eq 1 ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  create-update-config:
    runs-on: ubuntu-latest
    needs: should-run
    if: needs.should-run.outputs.should_run == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 1
      
      - name: Create or update config.yml for new or updated jurisdiction
        run: |
          updated_data_file_path=$(echo "${{ github.event.pull_request.changed_files }}" | grep -E "data/.+\.yml" | head -n 1)
          echo "Updated data file path: $updated_data_file_path"
          poetry run python scripts/github_actions/local/pull_request/create_update_config.py "$updated_data_file_path"

      - name: Commit config.yml updates
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update config.yml for new/updated jurisdiction [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi